---
title: "Goã‚µãƒ¼ãƒã¨Dartã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ã˜ã‚ã‚‹gRPC"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go","dart","grpc","protobuf"]
published: false
---

# ã¯ã˜ã‚ã«
Goè£½ã®APIã‚µãƒ¼ãƒã¨Dartã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆFlutterã‚’æƒ³å®šï¼‰é–“ã®é€šä¿¡ã‚’gRPCã§è¡Œã†æ–¹æ³•ã«ã¤ã„ã¦æ›¸ãã¾ã™

[æ—¥æ¯”è°·éŸ³æ¥½ç¥­ãŠã•ã‚“ã½ã‚¢ãƒ—ãƒª2020 é–‹ç™ºã®è£å´ã‚’èªã‚‹ / ã‚µãƒ¼ãƒãƒ¼ç·¨](https://engineer.dena.com/posts/2020.06/2020-hibiya-festival-server/)ã¨ã„ã†DeNAã®20æ–°å’ã€21å’å†…å®šè€…ã®æ–¹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ãŸã®ã§å…±æœ‰ã—ã¦ãŠãã¾ã™ã€‚

ã¾ãŸã€ãªãœgRPCã‚’ä½¿ã†ã¨å¬‰ã—ã„ã®ã‹ã¯ã€Cloud Native Days Tokyo 2020ã®å— ç›´ã•ã‚“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ ["Real World Migration from HTTP to gRPC"](https://event.cloudnativedays.jp/cndt2020/talks/14)ã‚’èãã¨ã‚ã‹ã‚Šã‚„ã™ã„ã®ã§ã“ã¡ã‚‰ã‚‚å…±æœ‰ã—ã¦ãŠãã¾ã™ã€‚ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‹•ç”»ã«é£›ã¹ã¾ã™ã€‚

# æº–å‚™
.protoãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã™ã‚‹ã«ã¯protocã‚³ãƒãƒ³ãƒ‰ã¨å‘¨è¾ºãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒãƒ­ãƒ¼ã‚«ãƒ«ã«ã„ã‚ã„ã‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã¯å«Œãªã®ã§ã€Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã¦å„è¨€èªã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ç¾åœ¨ã®ProtocolBuffersã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯[GitHubã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/protocolbuffers/protobuf/releases)ã‹ã‚‰ç¢ºèªã§ãã¾ã™

Dockerfile
```dockerfile

FROM golang:1.15.0

ENV DEBIAN_FRONTEND=noninteractive

ARG PROTO_VERSION=3.13.0

WORKDIR /proto

COPY ./proto .

RUN mkdir /output /output/server /output/client

RUN apt-get -qq update && apt-get -qq install -y \
  unzip

RUN curl -sSL https://github.com/protocolbuffers/protobuf/releases/download/v${PROTO_VERSION}/protoc-${PROTO_VERSION}-linux-x86_64.zip -o protoc.zip && \
  unzip -qq protoc.zip && \
  cp ./bin/protoc /usr/local/bin/protoc && \
  cp -r ./include /usr/local

# Go
RUN go get -u github.com/golang/protobuf/protoc-gen-go

# Dart
RUN apt-get install apt-transport-https
RUN sh -c 'curl https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -'
RUN sh -c 'curl https://storage.googleapis.com/download.dartlang.org/linux/debian/dart_stable.list > /etc/apt/sources.list.d/dart_stable.list'
RUN apt-get update
RUN apt-get install dart -y
ENV PATH="${PATH}:/usr/lib/dart/bin/"
ENV PATH="${PATH}:/root/.pub-cache/bin"
RUN pub global activate protoc_plugin
```

ã“ã®ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™

protoc.sh
```shell
#!/bin/sh

set -xe

SERVER_OUTPUT_DIR=/output/server
CLIENT_OUTPUT_DIR=/output/client

protoc --version
protoc -I=/proto/protos hoge.proto fuga.proto\
  --go_out=plugins="grpc:${SERVER_OUTPUT_DIR}" \
  --dart_out="grpc:${CLIENT_OUTPUT_DIR}"

# protoãƒ•ã‚¡ã‚¤ãƒ«å†…ã§timestamp.protoãªã©ã‚’importã—ãŸã¨ãã«å¿…è¦
protoc -I=/proto/protos timestamp.proto wrappers.proto\
  --dart_out="grpc:${CLIENT_OUTPUT_DIR}"

```

docker-composeã‚’ä½¿ç”¨ã™ã‚‹éš›ã¯commandã§ã€å…ˆã»ã©ã®protoc.shã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãŠã‘ã°ç«‹ã¡ä¸Šã’æ™‚ã«è‡ªå‹•ã§ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚volumesã§protoãƒ•ã‚¡ã‚¤ãƒ«ã¨protoc.shãŒå…¥ã£ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã‚µãƒ¼ãƒå´ã®å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’åŒæœŸã•ã›ã¾ã™ã€‚

docker-compose.yml
```yaml
version: '3.8'

services:
  proto:
    build:
      context: .
      dockerfile: docker/proto/Dockerfile
    command: ./protoc.sh
    volumes:
      - ./proto:/proto
      - ./client:/output/client
      - ./server:/output/server
```

ãŸã ã—ã€protoãƒ•ã‚¡ã‚¤ãƒ«å´ã§goãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æŒ‡å®šã™ã‚‹å ´åˆã€ä¾‹ãˆã°

hoge.proto
```proto
syntax = "proto3";

package hoge.hoge;

option go_package = "hoge/fuga/foo/bar";

service Hoge{
}

```
ã ã¨ã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠå´ã®```/output/server/hoge/fuga/foo```ã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

# ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ï¼ˆGoï¼‰
docker-compose.ymlã§æŒ‡å®šã—ãŸvolumesã«```hoge.pb.go```ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãã®ä¸­ã«Clinetã®Inerfaceå®šç¾©ãŒã‚ã‚‹ã®ã§ï¼ˆctxã§ãƒ•ã‚¡ã‚¤ãƒ«å†…æ¤œç´¢ã™ã‚‹ã¨è¦‹ã¤ã‹ã‚Šã‚„ã™ã„ï¼‰ã€ãã®éƒ¨åˆ†ã‚’ã¿ã¦ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

hoge.pb.go
```go
// HogeClient is the client API for Hoge service.
//
// For semantics around ctx use and closing/ending streaming RPCs, please refer to https://godoc.org/google.golang.org/grpc#ClientConn.NewStream.
type HogeClient interface {
	CreateHoge(ctx context.Context, in *CreateHogeMessage, opts ...grpc.CallOption) (*CreateHogeResponse, error)
}
```

HogeClientã‚’å®Ÿè£…ã™ã‚‹ã‚¯ãƒ©ã‚¹ã¨ã—ã¦HogeControllerã‚’ã¤ãã‚Šã¾ã™ã€‚ã“ã“ã§æ³¨æ„ãªã®ãŒã€ç¬¬ï¼“å¼•æ•°ä»¥é™ã§å¯å¤‰é•·å¼•æ•°ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ãŒã€å®Ÿè£…å´ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯optsã¯æ›¸ã‹ãªãã¦ã„ã„ã§ã™ã€‚

hoge_controller.go
```go
type HogeController struct{
}

func (ctrl HogeController) CreateHoge(ctx context.Context, in *CreateHogeMessage) (*CreateHogeResponse, error){
	// TODO: return *CreateHogeResponse, error
}
```

ä¸Šã§ä½œã£ãŸHogeControllerã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’RegisterHogeServer()ã§gRPCã‚µãƒ¼ãƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç™»éŒ²ã—ã¾ã™ã€‚

main.go
```go
func main() {
	listenPort, err := net.Listen("tcp", ":8000")
	if err != nil {
		log.Fatalln(err)
	}
	server := grpc.NewServer()

	hogeCtrl := NewHogeController()
	pb.RegisterHogeServer(server, &hogeCtrl)

	if err := server.Serve(listenPort); err != nil {
		log.Fatalf("failed to serve: %v", err)
	}
}
```

# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼ˆDartï¼‰
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯```hoge.pb.dart```, ```hoge.pbgrpc.dart```, ```hoge.pbjson.dart```, enumã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯```hoge.pbenum.dart```ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

protoãƒ•ã‚¡ã‚¤ãƒ«å´ã§timestamp.dartã‚’ä½¿ç”¨ã—ãŸå ´åˆã¯ç”Ÿæˆã•ã‚ŒãŸãƒ‘ã‚¹ã§ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§å˜ç´”ã«```hoge.pb.dart```å†…ã®importæ–‡ã‚’```import 'timestamp.pb.dart' as $1;```ã®ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã¨ä½¿ç”¨ã§ãã¾ã™ã€‚Unary Callã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢æ•°ã§é€šä¿¡ã§ãã¾ã™ã€‚

hoge.dart
```dart
Future<void> createHoge(dartSideParam1, dartSideParam2, dartSideParam3) async {
    final channel = ClientChannel('localhost',
        port: 8000,
        options:
            const ChannelOptions(credentials: ChannelCredentials.insecure()));
    final grpcClient = KitchenClient(channel,
        options: CallOptions(timeout: Duration(seconds: 10)));
    try {
      await grpcClient.createHoge(CreateHogerMessage()
        ..param1 = dartSideParam1
        ..param2 = dartSideParam2
        ..param3 = dartSideParam3;
      await channel.shutdown();
    } catch (error) {
      developer.log('Caught error: $error');
      await channel.shutdown();
      return Future.error(error);
    }
}

```

# ã¾ã¨ã‚
gRPCã‚’ä½¿ç”¨ã—ã¦Goã¨Darté–“ã‚’é€šä¿¡ã™ã‚‹æ–¹æ³•ã§ã—ãŸã€‚æ¥­å‹™ã§ã¯Server Streamingæ–¹å¼ã®é€šä¿¡ã‚’ä½¿ç”¨ã—ã¦å®Ÿè£…ã‚’ã—ã¦ã„ã‚‹ã¨ã“ã‚ã‚‚ã‚ã‚‹ã®ã§ã€å¾Œæ—¥ãã®æƒ…å ±ã‚‚å…±æœ‰ã—ã¦ã„ããŸã„ã§ã™ã€‚

